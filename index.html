<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的簡易版 YouTube (CORS 修復版)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
        .control-panel { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .search-box { display: flex; gap: 10px; margin-top: 10px; }
        input { padding: 10px; flex-grow: 1; }
        button { padding: 10px 20px; cursor: pointer; background: #ff0000; color: white; border: none; border-radius: 4px; }
        button:hover { background: #cc0000; }
        select { padding: 10px; border-radius: 4px; border: 1px solid #ccc; width: 100%; }
        #results { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .video-card { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }
        .video-card:hover { transform: translateY(-5px); }
        .video-card img { width: 100%; border-radius: 4px; aspect-ratio: 16/9; object-fit: cover; }
        .video-card h3 { font-size: 14px; margin: 10px 0; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        /* 播放器樣式 */
        .player-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .player-content { width: 90%; max-width: 800px; background: #000; position: relative; }
        video { width: 100%; display: block; }
        .close-btn { position: absolute; top: -40px; right: 0; color: white; font-size: 24px; cursor: pointer; background: none; border: none; }
        .status-msg { color: #666; font-size: 0.9em; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="control-panel">
        <h3>1. 選擇伺服器 (如果報錯就換一個)</h3>
        <select id="apiSelect">
            <option value="https://pipedapi.kavin.rocks">官方 (kavin.rocks) - 可能不穩定</option>
            <option value="https://api.piped.privacy.com.de">德國 (privacy.com.de) - 推薦</option>
            <option value="https://piped-api.lunar.icu">Lunar (lunar.icu)</option>
            <option value="https://pipedapi.tokhmi.xyz">Tokhmi (tokhmi.xyz)</option>
            <option value="https://api-piped.mha.fi">芬蘭 (mha.fi)</option>
        </select>
        
        <h3>2. 搜尋影片</h3>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="輸入關鍵字 (例如: 台灣新聞)">
            <button onclick="searchVideo()">搜尋</button>
        </div>
        <div id="statusMsg" class="status-msg"></div>
    </div>

    <div id="results"></div>

    <div id="playerOverlay" class="player-overlay">
        <div class="player-content">
            <button class="close-btn" onclick="closePlayer()">✕ 關閉</button>
            <video id="videoPlayer" controls></video>
        </div>
    </div>

    <script>
        // 取得使用者選擇的 API 網址
        function getApiBase() {
            return document.getElementById('apiSelect').value;
        }

        function showStatus(msg) {
            document.getElementById('statusMsg').textContent = msg;
        }

        async function searchVideo() {
            const query = document.getElementById('searchInput').value;
            const resultsDiv = document.getElementById('results');
            const apiBase = getApiBase();

            if (!query) return;

            resultsDiv.innerHTML = '';
            showStatus(`正在連線到 ${apiBase} 搜尋中...`);
            
            try {
                // 發送請求
                const response = await fetch(`${apiBase}/search?q=${encodeURIComponent(query)}&filter=all`);
                
                if (!response.ok) {
                    throw new Error(`伺服器回應錯誤: ${response.status}`);
                }

                const data = await response.json();
                showStatus(`搜尋完成，找到 ${data.items.length} 筆結果。`);

                data.items.forEach(item => {
                    if (item.type === 'stream') {
                        const card = document.createElement('div');
                        card.className = 'video-card';
                        card.onclick = () => playVideo(item.url); // 點擊卡片播放
                        card.innerHTML = `
                            <img src="${item.thumbnail}" alt="${item.title}" loading="lazy">
                            <h3>${item.title}</h3>
                        `;
                        resultsDiv.appendChild(card);
                    }
                });

            } catch (error) {
                console.error(error);
                showStatus(`錯誤: ${error.message}。請嘗試切換上方的伺服器選單再試一次。`);
            }
        }

        async function playVideo(videoUrl) {
            const videoId = videoUrl.split('v=')[1];
            const apiBase = getApiBase();
            const playerOverlay = document.getElementById('playerOverlay');
            const videoPlayer = document.getElementById('videoPlayer');

            showStatus('正在解析影片網址...');

            try {
                const response = await fetch(`${apiBase}/streams/${videoId}`);
                if (!response.ok) throw new Error('無法獲取影片資訊');
                
                const data = await response.json();
                
                // 尋找 1080p 的 mp4，如果沒有就找第一個有聲音的 mp4
                const stream = data.videoStreams.find(s => s.quality === '1080p' && s.mimeType.includes('mp4')) 
                            || data.videoStreams.find(s => s.mimeType.includes('mp4') && !s.videoOnly)
                            || data.videoStreams[0];

                if (stream) {
                    videoPlayer.src = stream.url;
                    playerOverlay.style.display = 'flex';
                    videoPlayer.play();
                    showStatus('開始播放');
                } else {
                    alert('找不到可播放的格式');
                }

            } catch (error) {
                console.error(error);
                alert(`播放失敗: ${error.message}，請換個伺服器試試`);
            }
        }

        function closePlayer() {
            const playerOverlay = document.getElementById('playerOverlay');
            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.pause();
            videoPlayer.src = "";
            playerOverlay.style.display = 'none';
        }
    </script>
</body>
</html>
