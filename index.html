<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewPipe Web版 (含強力穿透)</title>
    <style>
        /* 介面樣式 */
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; color: #333; max-width: 1000px; margin: 0 auto; }
        
        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .row { margin-bottom: 15px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; }
        
        select, input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        
        /* 特別設計的開關 */
        .proxy-switch { background: #e3f2fd; padding: 10px; border-radius: 6px; border: 1px solid #2196f3; color: #0d47a1; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .proxy-switch input { transform: scale(1.5); cursor: pointer; }

        button { width: 100%; padding: 12px; background: #ff0000; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: 0.2s; }
        button:hover { background: #cc0000; }

        #msg { margin-top: 10px; font-size: 14px; min-height: 20px; color: #555; }

        /* 影片列表 */
        #list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; background: #eee; }
        .card h4 { margin: 10px; font-size: 14px; line-height: 1.4; }

        /* 播放器 */
        #player { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        video { width: 90%; max-width: 800px; aspect-ratio: 16/9; background: black; }
        .close-btn { color: white; background: none; border: 1px solid white; width: auto; padding: 5px 20px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="panel">
        <div class="row">
            <label>1. 選擇伺服器 (API Instance)</label>
            <select id="api">
                <option value="https://pipedapi.kavin.rocks">Kavin (官方/較慢)</option>
                <option value="https://api.piped.projectsegfau.lt">Project Segfault</option>
                <option value="https://pipedapi.tokhmi.xyz">Tokhmi</option>
                <option value="https://api-piped.mha.fi">MHA (芬蘭)</option>
                <option value="https://pipedapi.smnz.de">SMNZ (德國)</option>
            </select>
        </div>

        <div class="row">
            <label class="proxy-switch">
                <input type="checkbox" id="useProxy" checked>
                <span><b>開啟「強力穿透模式」 (解決 CORS 報錯)</b><br><small>如果搜尋失敗，請務必勾選這個選項！</small></span>
            </label>
        </div>

        <div class="row">
            <input type="text" id="kw" placeholder="輸入關鍵字..." value="周杰倫">
        </div>

        <button onclick="startSearch()">搜尋影片</button>
        <div id="msg">準備就緒...</div>
    </div>

    <div id="list"></div>

    <div id="player">
        <button class="close-btn" onclick="document.getElementById('player').style.display='none';document.querySelector('video').pause()">✕ 關閉播放</button>
        <video controls playsinline></video>
    </div>

    <script>
        // 這是公開的 CORS Proxy 服務，它會幫我們轉發請求
        const PROXY_URL = "https://api.allorigins.win/raw?url="; 
        // 備用: "https://corsproxy.io/?" (如果上面那個掛了可以換這個)

        function log(text, isError = false) {
            const el = document.getElementById('msg');
            el.textContent = text;
            el.style.color = isError ? 'red' : 'green';
        }

        async function startSearch() {
            const kw = document.getElementById('kw').value;
            const api = document.getElementById('api').value;
            const useProxy = document.getElementById('useProxy').checked;
            const list = document.getElementById('list');

            if(!kw) return log("請輸入關鍵字", true);

            log("搜尋中...");
            list.innerHTML = "";

            // 組合網址
            let targetUrl = `${api}/search?q=${encodeURIComponent(kw)}&filter=videos`;
            
            // 如果勾選了代理，就把網址包一層
            if(useProxy) {
                // 注意：這裡我們把目標網址當作參數傳給 Proxy
                targetUrl = PROXY_URL + encodeURIComponent(targetUrl);
            }

            try {
                const res = await fetch(targetUrl);
                if(!res.ok) throw new Error("連線失敗: " + res.status);
                
                const data = await res.json();
                
                if(!data.items || data.items.length === 0) {
                    log("找不到影片，請換個關鍵字或伺服器", true);
                    return;
                }

                log(`找到 ${data.items.length} 部影片`);

                data.items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.innerHTML = `
                        <img src="${item.thumbnail}" onerror="this.src='https://via.placeholder.com/300?text=No+Img'">
                        <h4>${item.title}</h4>
                    `;
                    // 點擊卡片時播放
                    div.onclick = () => playVideo(item.url, api, useProxy);
                    list.appendChild(div);
                });

            } catch(e) {
                console.error(e);
                log("發生錯誤: " + e.message + " (請嘗試勾選/取消強力穿透模式，或換個伺服器)", true);
            }
        }

        async function playVideo(url, api, useProxy) {
            const id = url.split("v=")[1];
            if(!id) return;

            log("正在解析影片地址...");
            let targetUrl = `${api}/streams/${id}`;
            
            if(useProxy) {
                targetUrl = PROXY_URL + encodeURIComponent(targetUrl);
            }

            try {
                const res = await fetch(targetUrl);
                const data = await res.json();
                
                // 找 mp4
                const stream = data.videoStreams.find(s => s.quality === '1080p' && s.mimeType.includes('mp4') && !s.videoOnly) 
                            || data.videoStreams.find(s => s.mimeType.includes('mp4') && !s.videoOnly)
                            || data.videoStreams[0];

                if(stream) {
                    const v = document.querySelector('video');
                    const p = document.getElementById('player');
                    v.src = stream.url; 
                    p.style.display = 'flex';
                    v.play();
                    log("播放中");
                } else {
                    alert("無法播放此影片");
                }
            } catch(e) {
                log("播放解析失敗", true);
            }
        }
    </script>
</body>
</html>
