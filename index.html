<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewPipe V21 (æ»‘å‹•æ“æ§ç‰ˆ)</title>
    <style>
        body { font-family: "Segoe UI", sans-serif; background: #121212; color: #e0e0e0; margin: 0; padding: 20px; display: flex; gap: 20px; height: 100vh; box-sizing: border-box; user-select: none; /* é˜²æ­¢æ‹–å‹•æ™‚é¸å–æ–‡å­— */ }
        .main-stage { flex: 2; display: flex; flex-direction: column; gap: 15px; }
        .box { background: #1e1e1e; padding: 20px; border-radius: 12px; border: 1px solid #333; }
        
        select, input { width: 100%; padding: 12px; background: #000; color: #fff; border: 1px solid #444; border-radius: 6px; box-sizing: border-box; margin-bottom: 10px; font-size: 16px; }
        
        .controls { display: flex; gap: 10px; }
        button { flex: 1; padding: 12px; border-radius: 6px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-start { background: #2196f3; color: white; }
        .btn-start:hover { background: #1976d2; }
        .btn-stop { background: #f44336; color: white; display: none; }
        .btn-stop:hover { background: #d32f2f; }

        .progress-bar { height: 4px; background: #333; margin-top: 15px; border-radius: 2px; overflow: hidden; display: none; }
        .progress-value { height: 100%; background: #2196f3; width: 0%; animation: loading 1s infinite linear; }
        @keyframes loading { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        #log { font-family: monospace; color: #aaa; font-size: 12px; margin-top: 10px; height: 80px; overflow-y: auto; background: #000; padding: 8px; border-radius: 4px; }
        
        /* === æ’­æ”¾å™¨å®¹å™¨ === */
        .media-container { position: relative; width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 8px; overflow: hidden; }
        #mainPlayer { width: 100%; height: 100%; object-fit: contain; }
        
        /* === éŸ³æ¨‚æ¨¡å¼é®ç½©å±¤ === */
        #audioOverlay { 
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, #1a1a1a 0%, #000 100%); 
            z-index: 20; flex-direction: column; align-items: center; justify-content: center; 
            padding-bottom: 20px; box-sizing: border-box;
        }

        #albumArt { 
            width: 140px; height: 140px; border-radius: 50%; object-fit: cover; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 15px; border: 4px solid #333; 
            cursor: pointer; transition: transform 0.2s;
            animation: spin 20s linear infinite;
            animation-play-state: paused; 
        }
        #albumArt:active { transform: scale(0.95); }

        .song-info { text-align: center; margin-bottom: 20px; width: 80%; }
        .song-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-artist { font-size: 14px; color: #888; }

        /* æ§åˆ¶å€å¡Š (é€²åº¦æ¢ + éŸ³é‡) */
        .audio-controls { width: 85%; display: flex; flex-direction: column; gap: 20px; }
        
        /* === é€šç”¨æ»‘å‹•æ¢æ¨£å¼ (é€²åº¦æ¢ & éŸ³é‡æ¢) === */
        .slider-container { 
            width: 100%; height: 24px; display: flex; align-items: center; cursor: pointer; position: relative; 
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿä¸Šä¸‹æ»‘å‹•å¹²æ“¾ */
        }
        .slider-track { 
            width: 100%; height: 4px; background: #444; border-radius: 2px; position: relative; 
        }
        .slider-fill { 
            height: 100%; background: #2196f3; width: 0%; border-radius: 2px; position: absolute; top: 0; left: 0; pointer-events: none; 
        }
        /* åœ“çƒ (Thumb) */
        .slider-thumb {
            width: 14px; height: 14px; background: #fff; border-radius: 50%;
            position: absolute; top: 50%; left: 0%; 
            transform: translate(-50%, -50%); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            pointer-events: none;
            z-index: 2;
            transition: transform 0.1s;
        }
        
        .slider-container:hover .slider-track { height: 6px; border-radius: 3px; }
        .slider-container:hover .slider-thumb { transform: translate(-50%, -50%) scale(1.3); }

        .time-labels { display: flex; justify-content: space-between; font-size: 12px; color: #ccc; font-family: monospace; margin-top: -8px; }

        /* éŸ³é‡å€å¡Š */
        .volume-wrapper { display: flex; align-items: center; gap: 12px; width: 100%; }
        .vol-icon { cursor: pointer; font-size: 18px; width: 24px; text-align: center; }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* å³å´æ¸…å–® */
        .playlist-sidebar { flex: 1; background: #181818; border-radius: 12px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; min-width: 320px; }
        .playlist-header { padding: 15px; background: #252526; border-bottom: 1px solid #333; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .playlist-items { flex: 1; overflow-y: auto; }
        
        .item { display: flex; gap: 10px; padding: 10px; border-bottom: 1px solid #2a2a2a; cursor: pointer; transition: 0.2s; }
        .item:hover { background: #333; }
        .item.active { background: #3a2a2a; border-left: 4px solid #2196f3; }
        .item img { width: 100px; height: 56px; object-fit: cover; border-radius: 4px; background: #333; }
        .item-info { display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .item-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .item-index { font-size: 11px; color: #666; margin-right: 5px; min-width: 25px; }
    </style>
</head>
<body>

    <div class="main-stage">
        <div class="box">
            <h2>ğŸš€ NewPipe V21 (æ»‘å‹•æ“æ§ç‰ˆ)</h2>
            
            <label style="font-size:12px; color:#aaa;">æ’­æ”¾æ¨¡å¼:</label>
            <select id="qualitySelect" onchange="toggleMode()">
                <option value="audio">ğŸµ ç´”éŸ³è¨Šæ¨¡å¼ (éš±è—ç•«é¢)</option>
                <option value="best">ğŸ“º æœ€ä½³ç•«è³ª (720p)</option>
                <option value="360p">ğŸ“‰ çœæµå½±ç‰‡ (360p)</option>
            </select>

            <input type="text" id="inputUrl" value="https://www.youtube.com/playlist?list=PLMh3iZXeWr1fZIr9ETGlREZgGQ2FbF_vF" placeholder="è²¼ä¸Šæ’­æ”¾æ¸…å–® ID">
            
            <div class="controls">
                <button class="btn-start" id="btnStart" onclick="startAutoLoad()">â–¶ é–‹å§‹å¸å–</button>
                <button class="btn-stop" id="btnStop" onclick="stopLoading()">â¹ åœæ­¢</button>
            </div>

            <div class="progress-bar" id="pBar"><div class="progress-value"></div></div>
            <div id="log">æº–å‚™å°±ç·’...</div>
        </div>
        
        <div class="media-container">
            <video id="mainPlayer" controls playsinline></video>
            
            <div id="audioOverlay">
                <img id="albumArt" src="https://via.placeholder.com/150" onclick="togglePlayPause()" title="é»æ“Šæš«åœ/æ’­æ”¾">
                
                <div class="song-info">
                    <div class="song-title" id="displayTitle">æº–å‚™æ’­æ”¾</div>
                    <div class="song-artist" id="displayAuthor">...</div>
                </div>

                <div class="audio-controls">
                    <div class="slider-container" id="seekBar">
                        <div class="slider-track">
                            <div class="slider-fill" id="seekFill"></div>
                            <div class="slider-thumb" id="seekThumb"></div>
                        </div>
                    </div>
                    <div class="time-labels">
                        <span id="currTimeText">0:00</span>
                        <span id="durTimeText">0:00</span>
                    </div>

                    <div class="volume-wrapper">
                        <div class="vol-icon" onclick="toggleMute()" id="volIcon">ğŸ”Š</div>
                        <div class="slider-container" id="volBar">
                            <div class="slider-track">
                                <div class="slider-fill" id="volFill" style="width: 100%;"></div>
                                <div class="slider-thumb" id="volThumb" style="left: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="playlist-sidebar">
        <div class="playlist-header">
            <span>æ’­æ”¾æ¸…å–®</span>
            <span id="pl-count" style="background:#2196f3; padding:2px 6px; border-radius:4px; font-size:12px;">0</span>
        </div>
        <div class="playlist-items" id="pl-list"></div>
    </div>

    <script>
        const LOCAL_BRIDGE = "https://bridge.zihuanfeng520.workers.dev"; 
        const CLIENT_CONTEXT = {
            "context": {
                "client": {
                    "clientName": "ANDROID",
                    "clientVersion": "19.29.35",
                    "hl": "zh-TW", "gl": "TW",
                    "androidSdkVersion": 30
                }
            }
        };

        let isRunning = false;
        let totalLoaded = 0;
        let uniqueIds = new Set();
        let currentMeta = { thumb: "", title: "", author: "" }; 
        let lastVolume = 1.0; 
        
        // æ‹–æ›³ç‹€æ…‹æ——æ¨™
        let isDraggingSeek = false;
        let isDraggingVol = false;

        const logger = {
            log: (msg) => {
                const el = document.getElementById('log');
                el.innerText = `> ${msg}\n` + el.innerText;
            }
        };

        const player = document.getElementById('mainPlayer');
        
        // === æ ¸å¿ƒåŠŸèƒ½ï¼šæ»‘é¼ æ‹–æ›³é‚è¼¯ ===
        function setupDraggable(containerId, onDrag, onStop) {
            const container = document.getElementById(containerId);
            
            const handleMove = (e) => {
                const rect = container.getBoundingClientRect();
                let percent = (e.clientX - rect.left) / rect.width;
                if (percent < 0) percent = 0;
                if (percent > 1) percent = 1;
                onDrag(percent);
            };

            const handleUp = (e) => {
                document.removeEventListener('mousemove', handleMove);
                document.removeEventListener('mouseup', handleUp);
                if(onStop) onStop();
            };

            container.addEventListener('mousedown', (e) => {
                handleMove(e); // é»æ“Šç•¶ä¸‹å…ˆæ›´æ–°ä¸€æ¬¡
                document.addEventListener('mousemove', handleMove);
                document.addEventListener('mouseup', handleUp);
            });
        }

        // ç¶å®šé€²åº¦æ¢æ‹–æ›³
        setupDraggable('seekBar', (percent) => {
            isDraggingSeek = true; // é–ä½è‡ªå‹•æ›´æ–°
            updateSeekUI(percent * 100);
            if(player.duration) {
                // æ‹–æ›³æ™‚å³æ™‚é è¦½æ™‚é–“
                const previewTime = percent * player.duration;
                document.getElementById('currTimeText').innerText = formatTime(previewTime);
                // å¯é¸ï¼šå³æ™‚è·³è½‰ (Scrubbing) -> player.currentTime = previewTime;
            }
        }, () => {
            // æ”¾é–‹æ»‘é¼ æ™‚æ‰çœŸæ­£è·³è½‰ (é¿å…å¡é “)
            const percent = parseFloat(document.getElementById('seekFill').style.width) / 100;
            if(player.duration) player.currentTime = percent * player.duration;
            isDraggingSeek = false; // è§£é–
        });

        // ç¶å®šéŸ³é‡æ¢æ‹–æ›³
        setupDraggable('volBar', (percent) => {
            isDraggingVol = true;
            updateVolUI(percent);
            player.volume = percent;
            player.muted = false;
        }, () => {
            isDraggingVol = false;
        });


        // === æ’­æ”¾å™¨äº‹ä»¶ ===
        player.addEventListener('timeupdate', () => {
            if (!player.duration || isDraggingSeek) return; // å¦‚æœæ­£åœ¨æ‹–ï¼Œå°±ä¸è¦è¢«å½±ç‰‡æ›´æ–°æ‰“æ–·
            
            const percent = (player.currentTime / player.duration) * 100;
            updateSeekUI(percent);
            document.getElementById('currTimeText').innerText = formatTime(player.currentTime);
            document.getElementById('durTimeText').innerText = formatTime(player.duration);
        });

        player.addEventListener('play', () => {
            document.getElementById('albumArt').style.animationPlayState = 'running';
        });
        player.addEventListener('pause', () => {
            document.getElementById('albumArt').style.animationPlayState = 'paused';
        });

        player.addEventListener('volumechange', () => {
            if(!isDraggingVol) updateVolUI(player.volume);
            updateVolIcon();
        });

        // UI æ›´æ–° Helper
        function updateSeekUI(percent) {
            document.getElementById('seekFill').style.width = percent + '%';
            document.getElementById('seekThumb').style.left = percent + '%';
        }

        function updateVolUI(percent) {
            document.getElementById('volFill').style.width = (percent * 100) + '%';
            document.getElementById('volThumb').style.left = (percent * 100) + '%';
        }

        function updateVolIcon() {
            const volIcon = document.getElementById('volIcon');
            if(player.muted || player.volume === 0) volIcon.innerText = 'ğŸ”‡';
            else if(player.volume < 0.3) volIcon.innerText = 'ğŸ”ˆ';
            else if(player.volume < 0.7) volIcon.innerText = 'ğŸ”‰';
            else volIcon.innerText = 'ğŸ”Š';
        }

        function formatTime(seconds) {
            if(isNaN(seconds)) return "0:00";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        function togglePlayPause() {
            if (player.paused) player.play();
            else player.pause();
        }

        function toggleMute() {
            if(player.muted) {
                player.muted = false;
                player.volume = lastVolume || 0.5;
            } else {
                lastVolume = player.volume;
                player.muted = true;
            }
        }

        function toggleMode() {
            const mode = document.getElementById('qualitySelect').value;
            const overlay = document.getElementById('audioOverlay');
            if (mode === 'audio') {
                overlay.style.display = 'flex';
                updateVolUI(player.volume); // åˆ‡æ›å›ä¾†æ™‚åŒæ­¥éŸ³é‡æ¢ UI
            } else {
                overlay.style.display = 'none';
            }
        }

        // === è‡ªå‹•åŠ è¼‰ (ä¿æŒä¸è®Š) ===
        async function startAutoLoad() {
            const input = document.getElementById('inputUrl').value;
            let listId = input.includes("list=") ? input.split("list=")[1].split("&")[0] : input;
            const browseId = listId.startsWith("VL") ? listId : "VL" + listId;

            resetUI();
            setLoading(true);
            logger.log(`é–‹å§‹ä»»å‹™: ${browseId}`);

            try {
                let nextToken = await fetchAndProcess(browseId, null);
                while (nextToken && isRunning) {
                    await new Promise(r => setTimeout(r, 200));
                    nextToken = await fetchAndProcess(null, nextToken);
                }
                logger.log("âœ… æ¸…å–®è¼‰å…¥å®Œç•¢");
            } catch(e) {
                logger.log(`âŒ éŒ¯èª¤: ${e.message}`);
            } finally {
                setLoading(false);
            }
        }

        function stopLoading() {
            isRunning = false;
            logger.log("ğŸ›‘ å·²åœæ­¢");
        }

        async function fetchAndProcess(browseId, continuationToken) {
            let payload = { ...CLIENT_CONTEXT };
            if (browseId) payload.browseId = browseId;
            if (continuationToken) payload.continuation = continuationToken;

            const res = await fetch(LOCAL_BRIDGE + "/browse", { method: "POST", body: JSON.stringify(payload) });
            const data = await res.json();

            const videos = deepSearch(data, ['playlistVideoRenderer', 'videoRenderer']);
            if (videos.length > 0) renderVideos(videos);

            return findContinuationToken(data);
        }

        function findContinuationToken(data) {
            let commands = deepSearch(data, ['continuationCommand']);
            if (commands.length > 0) return commands[0].token;
            let nextData = deepSearch(data, ['nextContinuationData']);
            if (nextData.length > 0) return nextData[0].continuation;
            return null;
        }

        function deepSearch(obj, keysToFind, results = []) {
            if (!obj || typeof obj !== 'object') return results;
            for (const key of keysToFind) {
                if (obj[key]) results.push(obj[key]);
            }
            if (Array.isArray(obj)) {
                for (let item of obj) deepSearch(item, keysToFind, results);
            } else {
                for (let k in obj) deepSearch(obj[k], keysToFind, results);
            }
            return results;
        }

        function renderVideos(videoList) {
            const container = document.getElementById('pl-list');
            videoList.forEach(v => {
                if(!v.videoId || uniqueIds.has(v.videoId)) return;
                uniqueIds.add(v.videoId);
                totalLoaded++;

                const title = v.title.runs ? v.title.runs[0].text : (v.title.simpleText || "ç„¡æ¨™é¡Œ");
                let thumb = "https://via.placeholder.com/100x56";
                if (v.thumbnail?.thumbnails?.length) {
                    thumb = v.thumbnail.thumbnails[v.thumbnail.thumbnails.length - 1].url;
                }
                const author = v.shortBylineText?.runs[0]?.text || "";

                const el = document.createElement('div');
                el.className = 'item';
                el.onclick = () => {
                    document.querySelectorAll('.item').forEach(i => i.classList.remove('active'));
                    el.classList.add('active');
                    currentMeta = { thumb, title, author };
                    playVideo(v.videoId);
                };
                el.innerHTML = `
                    <div class="item-index">${totalLoaded}</div>
                    <img src="${thumb}">
                    <div class="item-info">
                        <div class="item-title">${title}</div>
                        <div style="font-size:11px; color:#888;">${author}</div>
                    </div>
                `;
                container.appendChild(el);
            });
            document.getElementById('pl-count').innerText = totalLoaded;
        }

        async function playVideo(videoId) {
            const mode = document.getElementById('qualitySelect').value;
            const overlay = document.getElementById('audioOverlay');

            logger.log(`è¼‰å…¥: ${currentMeta.title}`);

            if (mode === 'audio') {
                overlay.style.display = 'flex';
                document.getElementById('albumArt').src = currentMeta.thumb;
                document.getElementById('displayTitle').innerText = currentMeta.title;
                document.getElementById('displayAuthor').innerText = currentMeta.author;
                updateVolUI(player.volume); // åŒæ­¥éŸ³é‡
            } else {
                overlay.style.display = 'none';
            }

            try {
                const res = await fetch(LOCAL_BRIDGE + "/player", {
                    method: "POST",
                    body: JSON.stringify({
                        ...CLIENT_CONTEXT, "videoId": videoId,
                        "contentCheckOk": true, "racyCheckOk": true
                    })
                });
                const data = await res.json();
                
                if (data.playabilityStatus?.status !== "OK") throw new Error("ç„¡æ³•æ’­æ”¾");

                const formats = [...(data.streamingData?.formats||[])];
                let bestStream = null;

                if (mode === 'audio' || mode === '360p') {
                    bestStream = formats.find(f => f.itag === 18) || formats.find(f => f.height === 360);
                } else {
                    bestStream = formats.find(f => f.itag === 22) || formats[0];
                }

                if(bestStream) {
                    logger.log(`æ ¼å¼: ${bestStream.qualityLabel}`);
                    player.src = bestStream.url;
                    player.play();
                } else {
                    alert("æ‰¾ä¸åˆ°é©åˆæ ¼å¼");
                }
            } catch(e) {
                logger.log(`âŒ æ’­æ”¾å¤±æ•—: ${e.message}`);
            }
        }

        function resetUI() {
            document.getElementById('pl-list').innerHTML = "";
            document.getElementById('log').innerText = "æº–å‚™å°±ç·’...";
            totalLoaded = 0;
            uniqueIds.clear();
            isRunning = true;
        }

        function setLoading(loading) {
            document.getElementById('btnStart').style.display = loading ? 'none' : 'block';
            document.getElementById('btnStop').style.display = loading ? 'block' : 'none';
            document.getElementById('pBar').style.display = loading ? 'block' : 'none';
        }
    </script>
</body>
</html>
